<html>
    <head>
        <meta charset="utf-8">
        <title>Netronner - Tiles Of Fury</title>
        <link href="resources/favicon.ico" rel="icon" type="image/x-icon" />
        <link rel="shortcut icon" href="favicon.ico" />
        <link rel="stylesheet" type="text/css" href="lib/bootstrap.min.css" >
        <script src="lib/jquery-2.0.3.min.js"></script>    
        <script src="lib/handlebars-v1.3.0.js"></script>
        <script src="lib/bootstrap.min.js"></script>
        <script type="text/javascript">

            objects = {};
            // merges n objects in given order (leftmost on bottom, rightmost on top)
            objects.merge = function(){
                return Array.prototype.call(arguments).reduce(function(merged, mergee){
                    for(var k in mergee){
                        merged[k] = mergee[k];
                    }
                },{});
            };

            google = {};
            google.auth = {};
            google.auth.handler = function(ron, authResult) {
                if (authResult['status']['signed_in']) {
                    var accessToken = authResult['access_token'];
                    $.ajax({
                        url: "https://www.googleapis.com/plus/v1/people/me?access_token=" + accessToken,
                        success: function(data) {
                            var username = data["displayName"];
                            var unsizedUserIcon = data["image"]["url"].replace(/\?.*$/, "");
                            ron.logged(accessToken, username, unsizedUserIcon);
                        }
                    });
                } else {
                    console.log('Sign-in failure: ' + authResult['error']);
                }
            }

            function webapi() {
                this.baseUrl = "@@netronner.webapi.url@@";
            };

            webapi.prototype.request = function(endpoint, conf) {
                var url = [this.baseUrl, "api", endpoint].join('/');
                $.ajax(objects.merge({url: url}, conf));
            }

            function netronner() {
                this.templates = {}
                this.data = {}
                this.webapi = new webapi();
                this.templates.timeline = Handlebars.compile($("#timeline-template").html())
                this.templates.achievements = Handlebars.compile($("#achievements-template").html())
                this.templates.failure = Handlebars.compile($("#failure-template").html())
                this.templates.anon = Handlebars.compile($("#anon-template").html())
                this.templates.logged = Handlebars.compile($("#logged-template").html())
            }


            netronner.prototype.failure = function(response) {
                function jsonTryParse(txt) {
                    try {
                        return JSON.parse(txt);
                    } catch (ex) {
                        return txt ? {message: txt} : {};
                    }
                }
            netronner.prototype.activateNav = function(nav){
                $("#nav li").removeClass("active");
                $("#nav ." + nav).addClass("active");
            };

            netronner.prototype.anon = function() {
                this.data.user = {};
                this.user_result(this.templates.anon(this.data.user));
            }

            netronner.prototype.logged = function(accessToken, username, userIcon) {
                this.result(this.templates.failure({
                    status: response.status,
                    value: jsonTryParse(response.responseText)
                }));
            }

            netronner.prototype.result = function(content) {
                $('#results').html(content);
            }

            netronner.prototype.user_result = function(content) {
                $('#user_info').html(content);
            }

            netronner.prototype.timeline = function() {
                this.activateNav("timeline");
                location.hash = "#timeline";
                // TODO: render loadMask
                this.webapi.request("timeline/latest",{
                    success: function(data){
                        this.data.previousPage = data["previous"];
                        if(!this.data.timelineEvents){
                            this.data.timelineEvents = [];
                        }
                        this.data.timelineEvents.push.apply(this.data.timelineEvents, data["events"]);
                        this.result(this.templates.timeline(this.data.timeline));
                        //TODO: register handler to fetch next page when scrolling to bottom
                    }
                });

            };

            netronner.prototype.achievements = function() {
                this.activateNav("achievements");
                location.hash = "#achievements";
                // TODO: render loadMask
                this.webapi.request("achievements",{
                    success: function(data){
                        this.data.achievements = data;
                        this.result(this.templates.achievements(this.data.achievements));
                    }
                });
            };

            netronner.prototype.renderHash = function(_newHash) {
                if (location.hash && location.hash !== "#") {
                    var templateName = location.hash.slice(1);
                    if (typeof netronner.prototype[templateName] === "function") {
                        netronner.prototype[templateName].call(this);
                    }
                }
            };
            
            netronner.prototype.activateNav = function(nav){
                $("#nav li").removeClass("active");
                $("#nav ." + nav).addClass("active");
            };

            netronner.prototype.anon = function() {
                this.data.user = {};
                this.user_result(this.templates.anon(this.data.user));
            }

            netronner.prototype.logged = function(accessToken, username, userIcon) {
                this.data.user = {
                    accessToken: accessToken,
                    username : username,
                    userIcon: userIcon
                };
                this.user_result(this.templates.logged(this.data.user));
            }

            var ron = null;

            $(document).ready(function() {
                ron = new netronner();
                authHandler = google.auth.handler.bind(this, ron);
                if (location.hash && location.hash !== "#") {
                    ron.renderHash()
                } else {
                    ron.timeline();
                }
                ron.anon();
                window.onhashchange = ron.renderHash.bind(ron);
            })
        </script>
        <style>
            html, body { height: 100%; }
            body { background-color: #398439;}
            #wrap {
                min-height: 100%;
                height: auto;
                margin: 0 auto -60px;
                padding: 0 0 60px;
            }
            #wrap > .container { padding: 60px 15px 0; }
        </style>

    </head>
    <body>
        <div id="wrap">
            <div class="navbar navbar-default navbar-fixed-top" role="navigation">
                <div class="container">
                    <div class="navbar-header">
                        <span class="navbar-brand">Netronner</span>
                    </div>
                    <div class="collapse navbar-collapse">
                        <ul class="nav navbar-nav" id="nav">
                            <li class="timeline active"><a href="#timeline">Timeline</a></li>
                            <li class="achievements"><a href="#achievements">Achievements</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="container" >
                <div class="row">
                    <div class="col-md-3">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <img src="resources/tilesoffury-logo-240-149.png" />
                            </div>
                            <div id="user_info" class="panel-body">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="row" id="results">
                        </div>
                    </div>

                </div>
            </div>
        </div> 

        <script id="timeline-template" type="text/x-handlebars-template">
            {{#unless this}}
            <div class="row">
            <div class="col-md-12">
            <div class="panel panel-danger">
            <div class="panel-body">Nothing happened.</div>
            </div>
            </div>
            </div>
            {{/unless}}
            {{#each this}}
            <div class="row">
            <div class="col-md-12">
            <div class="panel panel-default">
            <div class="panel-heading">{{name}}</div>
            <div class="panel-body">
            {{#each achievements}}
            <div class="btn-group">
            <a href="#achievements" class="btn btn-info btn-sm">{{this}}</a>
            </div>
            {{/each}}

            </div>
            </div>
            </div>
            </div>
            {{/each}}    
        </script>

        <script id="failure-template" type="text/x-handlebars-template">
            <div class="panel panel-danger">
            <div class="panel-heading">An error occurred</div>
            <div class="panel-body">
            <dl class="dl-horizontal">
            <dt>Error Code</dt><dd>{{status}}</dd>
            {{#each value}}
            <dt>{{@key}}</dt><dd>{{this}}</dd>      
            {{/each}}
            </dl>
            </div>
            </div>
        </script>

        <script id="achievements-template" type="text/x-handlebars-template">
            {{#unless this}}
            <div class="row">
            <div class="col-md-12">
            <div class="panel panel-danger">
            <div class="panel-body">Nothing to achieve here!</div>
            </div>
            </div>
            </div>
            {{/unless}}
            {{#each this}}
            <div class="row">
            <div class="col-md-12">
            <div class="panel panel-default">
            <div class="panel-heading">{{name}}</div>
            <div class="panel-body">
                {{description}}
            </div>
            </div>
            </div>
            </div>
            {{/each}}
        </script>

        <script id="anon-template" type="text/x-handlebars-template">
            <div class="col-md-offset-2 col-md-8">
                <span id="signinButton" >
                    <span
                        class="g-signin"
                        data-callback="authHandler"
                        data-clientid="@@google.client.id@@"
                        data-cookiepolicy="single_host_origin"
                        data-scope="profile">
                    </span>
                </span>
            </div>
        </script>

        <script id="logged-template" type="text/x-handlebars-template">
            <img src="{{userIcon}}?sz=70"
                 class="img-thumbnail"
                 style="width:70px; height:70px; margin:-40px 0 0 0" />
            {{username}}
            <div class="col-md-6">
                <!-- TODO: add onclick handler -->
                <button type="button" class="btn btn-default">Award achievement</button>
            </div>
        </script>


        <!-- Google+ auth -->
        <script type="text/javascript">
            (function() {
                var po = document.createElement('script');
                po.type = 'text/javascript';
                po.async = true;
                po.src = 'https://apis.google.com/js/client:plusone.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(po, s);
            })();
        </script>
    </body>
