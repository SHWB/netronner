<html>
    <head>
        <meta charset="utf-8">
        <title>Netronner - Tiles Of Fury</title>
        <link href="resources/favicon.ico" rel="icon" type="image/x-icon" />
        <link rel="shortcut icon" href="favicon.ico" />
        <link rel="stylesheet" type="text/css" href="lib/bootstrap.min.css" >
        <link rel="stylesheet" type="text/css" href="lib/bootstrap-combobox.css" >
        <link rel="stylesheet" type="text/css" href="netronner.css" >
        <script src="lib/jquery-2.0.3.min.js"></script>    
        <script src="lib/handlebars-v1.3.0.js"></script>
        <script src="lib/bootstrap.min.js"></script>
        <script src="lib/lambda-driver.js"></script>
        <script src="lib/data.js"></script>
        <script src="lib/bootstrap-store-combobox.js"></script>
                
        <script type="text/javascript">

            objects.namespace('Google.auth').handler = function(ron, authResult) {
                if (authResult['status']['signed_in']) {
                    var accessToken = authResult['access_token'];
                    $.ajax({
                        url: "https://www.googleapis.com/plus/v1/people/me?access_token=" + accessToken,
                        success: function(data) {
                            var id = data["id"];
                            var username = data["displayName"];
                            var unsizedUserIcon = data["image"]["url"].replace(/\?.*$/, "");
                            ron.logged(accessToken, id, username, unsizedUserIcon);
                        }
                    });
                } else {
                    console.log('Sign-in failure: ' + authResult['error']);
                }
            }

            function Webapi() {
                this.baseUrl = "@@netronner.webapi.url@@";
            };
            
            Webapi.prototype.endpoint = function(endpoint){
                return [this.baseUrl, "api", endpoint].join('/');
            }

            Webapi.prototype.request = function(endpoint, conf) {
                $.ajax(objects.merge({url: this.endpoint(endpoint)}, conf));
            };
            
            function Netronner() {
                this.templates = {};
                this.data = {};
                this.webapi = new Webapi();
                this.templates.timeline = Handlebars.compile($("#timeline-template").html());
                this.templates.achievements = Handlebars.compile($("#achievements-template").html());
                this.templates.player = Handlebars.compile($("#player-template").html());
                this.templates.failure = Handlebars.compile($("#failure-template").html());
                this.templates.anon = Handlebars.compile($("#anon-template").html());
                this.templates.logged = Handlebars.compile($("#logged-template").html());
            };
            
            Netronner.prototype.failure = function(response) {
                function jsonTryParse(txt) {
                    try {
                        return JSON.parse(txt);
                    } catch (ex) {
                        return txt ? {message: txt} : {};
                    }
                }
                this.result(this.templates.failure({
                    status: response.status,
                    value: jsonTryParse(response.responseText)
                }));
            };

            Netronner.prototype.result = function(content) {
                $('#results').html(content);
            };

            Netronner.prototype.user_result = function(content) {
                $('#user_info').html(content);
            };

            Netronner.prototype.timeline = function() {
                this.activateNav("timeline");
                location.hash = "#timeline";
                // TODO: render loadMask
                var self = this;
                this.webapi.request("timeline/latest",{
                    success: function(data){
                        self.data.nextPage = data["previous"];
                        self.data.timelineEvents = [];
                        self.data.timelineEvents.push.apply(self.data.timelineEvents, data["events"]);
                        self.result(self.templates.timeline(self.data.timelineEvents));
                        //TODO: register handler to fetch next page when scrolling to bottom
                    }
                });

            };

            Netronner.prototype.achievements = function(selectedName) {
                this.activateNav("achievements");
                location.hash = "#achievements" + (selectedName ? "/" + selectedName : "");
                // TODO: render loadMask
                var self = this;
                this.webapi.request("achievements",{
                    success: function(data){
                        self.data.achievements = data;
                        self.result(self.templates.achievements(self.data.achievements));
                        var selected =selectedName && document.getElementById("achievement_" + selectedName);
                        if(selected){
                            selected.scrollIntoView();
                        }
                    }
                });
            };

            Netronner.prototype.player = function(playerGoogleId) {
                this.deactivateNavs();
//                this.activateNav("player");
                location.hash = "#player/" + playerGoogleId;
                // TODO: render loadMask
                var self = this;
                this.webapi.request("players/" + playerGoogleId ,{
                    success: function(data){
                        self.data.player = data;
                        self.result(self.templates.player(self.data.player));
                        $('[data-toggle=tooltip]').tooltip();
                    }
                });
            };

            Netronner.prototype.renderHash = function(_newHash) {
                if (location.hash && location.hash !== "#") {
                    var pieces = location.hash.slice(1).split("/");
                    var templateName = pieces.shift();
                    if (typeof Netronner.prototype[templateName] === "function") {
                        Netronner.prototype[templateName].apply(this, pieces);
                    }
                }
            };
            
            Netronner.prototype.activateNav = function(nav){
                $("#nav li").removeClass("active");
                $("#nav ." + nav).addClass("active");
            };

            Netronner.prototype.deactivateNavs = function(){
                $("#nav li").removeClass("active");
            };

            Netronner.prototype.anon = function() {
                this.data.user = {};
                this.user_result(this.templates.anon(this.data.user));
            }

            Netronner.prototype.logged = function(accessToken, id, username, userIcon) {
                this.data.user = {
                    accessToken: accessToken,
                    id: id,
                    username : username,
                    userIcon: userIcon
                };
                this.user_result(this.templates.logged(this.data.user));
            };
            
            Handlebars.registerHelper('erl_time', function(erlTimestamp){
                var megaSecs = erlTimestamp[0];
                var secs = erlTimestamp[1];
                var microSecs = erlTimestamp[2];
                return new Date(megaSecs*1000000000 + secs*1000 + Math.floor(microSecs / 1000)).toLocaleString();
            });

            $(document).ready(function() {

                var netronner = new Netronner();
                $(".award-combo.achievement").combobox({
                    store: new Anima.data.Store({
                        url: netronner.webapi.endpoint('achievements'),
                        fields: ['name', 'description', 'icon']
                    }),
                    matchField: 'name',
                    valueField: 'name',
                    item: [
                        '<li>',
                        '<div class="media">',
                        '<a class="pull-left" href="#">',
                        '  <img class="media-object img-rounded" src="icons/{{icon}}" alt="{{name}}">',
                        '</a>',
                        '<div class="media-body">',
                        '   <h4 class="media-heading">{{{match}}}</h4>',
                        '    {{description}}',
                        '</div>',
                        '</div>',
                        '</li>'
                    ].join('')

                });
                
                //TODO: players combo
        
                objects.global().authHandler = Google.auth.handler.bind(this, netronner);
                if (location.hash && location.hash !== "#") {
                    netronner.renderHash();
                } else {
                    netronner.timeline();
                }
                netronner.anon();
                window.onhashchange = netronner.renderHash.bind(netronner);
            });
        </script>
        <style>
            html, body { height: 100%; }
            body { background-color: #398439;}
            #wrap {
                min-height: 100%;
                height: auto;
                margin: 0 auto -60px;
                padding: 0 0 60px;
            }
            #wrap > .container { padding: 60px 15px 0; }
        </style>

    </head>
    <body>
        <div id="wrap">
            <div class="navbar navbar-default navbar-fixed-top" role="navigation">
                <div class="container">
                    <div class="navbar-header">
                        <span class="navbar-brand">Netronner</span>
                    </div>
                    <div class="collapse navbar-collapse">
                        <ul class="nav navbar-nav" id="nav">
                            <li class="timeline active"><a href="#timeline">Timeline</a></li>
                            <li class="achievements"><a href="#achievements">Achievements</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="container" >
                <div class="row">
                    <div class="col-md-3">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <img src="resources/tilesoffury-logo-240-149.png" />
                            </div>
                            <div id="user_info" class="panel-body">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="row" id="results">
                        </div>
                    </div>

                </div>
            </div>
        </div>
        
        <!-- modals -->
        <div class="modal fade" id="award_window" tabindex="-1" role="dialog" aria-labelledby="awardAchievementLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                  <h4 class="modal-title" id="awardAchievementLabel">Award Achievement</h4>
                </div>
                <div class="modal-body">
                    <form role="form">
                        <div class="form-group">
                            <select class="award-combo player combobox form-control"></select>
                        </div>
                        <div class="form-group">
                            <select class="award-combo achievement combobox form-control"></select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary" data-dismiss="modal">Award</button>
                </div>
              </div>
            </div>
        </div>


        <!-- templates -->
        <script id="timeline-template" type="text/x-handlebars-template">
            {{#unless this}}
            <div class="row">
            <div class="col-md-12">
            <div class="panel panel-danger">
            <div class="panel-body">Nothing happened.</div>
            </div>
            </div>
            </div>
            {{/unless}}
            {{#each this}}
            <div class="row">
            <div class="col-md-12">
            <div class="panel panel-default">
            <div class="panel-body media">
            <a class="pull-left" href="#player/{{data.player.id}}">
              <img class="media-object img-rounded" src="{{data.player.image_url}}?sz=64" alt="{{data.player.name}}">
            </a>
            <a class="pull-left" href="#achievements/{{data.achievement.name}}">
              <img class="media-object" src="icons/{{data.achievement.icon}}" alt="{{data.achievement.name}}">
            </a>
            <div class="media-body">
              <h4 class="media-heading">Achievement unlock!</h4>
              <!-- TODO: player name should link to player gaming profile (does not exist yet) -->
              <a href="#player/{{data.player.id}}">{{data.player.name}}</a> unlocked achievement <a href="#achievements/{{data.achievement.name}}">{{data.achievement.name}}</a> !
            </div>

            </div>
            <div class="panel-footer"><small><em>{{erl_time timestamp}}</em></small></div>
            </div>
            </div>
            </div>
            {{/each}}    
        </script>

        <script id="failure-template" type="text/x-handlebars-template">
            <div class="panel panel-danger">
            <div class="panel-heading">An error occurred</div>
            <div class="panel-body">
            <dl class="dl-horizontal">
            <dt>Error Code</dt><dd>{{status}}</dd>
            {{#each value}}
            <dt>{{@key}}</dt><dd>{{this}}</dd>      
            {{/each}}
            </dl>
            </div>
            </div>
        </script>

        <script id="achievements-template" type="text/x-handlebars-template">
            {{#unless this}}
            <div class="row">
            <div class="col-md-12">
            <div class="panel panel-danger">
            <div class="panel-body">Nothing to achieve here!</div>
            </div>
            </div>
            </div>
            {{/unless}}
            {{#each this}}
            <div class="row">
            <div class="col-md-12">
            <div class="panel panel-default" id="achievement_{{name}}">
            <div class="panel-body media">
            <a class="pull-left" href="#">
              <!-- TODO: change icon with iconCls -->
              <img class="media-object img-rounded" src="icons/{{icon}}" alt="{{name}}">
            </a>
            <div class="media-body">
               <h4 class="media-heading">{{name}}</h4>
                {{description}}
            </div>
            </div>
            </div>
            </div>
            </div>
            {{/each}}
        </script>

        <script id="player-template" type="text/x-handlebars-template">
            {{#unless this}}
            <div class="row">
            <div class="col-md-12">
            <div class="panel panel-danger">
            <div class="panel-body">Unknown player</div>
            </div>
            </div>
            </div>
            {{/unless}}
            {{#if this}}
            <div class="row">
            <div class="col-md-12">
            <div class="panel panel-default">
            <div class="panel-body">
            <div class="media">
                <a class="pull-left" href="#">
                  <img class="media-object img-rounded" src="{{imageUrl}}?sz=64" alt="{{name}}">
                </a>
                <div class="media-body">
                    <h2 class="media-heading">{{name}}</h2>
                    <br>
                    <h3 class="media-heading">Achievements Unlocked</h3>
                    {{#each achievements}}
                        <div class="media" data-toggle="tooltip" title="{{description}}" data-placement="bottom">
                            <a class="pull-left" href="#achievements/{{name}}">
                              <img class="media-object" src="icons/{{icon}}" alt="{{name}}">
                            </a>
                            <div class="media-body">
                                <h4 class="media-heading">{{name}}</h4>
                            </div>
                        </div>
                    {{/each}}
                </div>
            </div>

            </div>
            </div>
            </div>
            </div>
            {{/if}}
        </script>

        <script id="anon-template" type="text/x-handlebars-template">
            <div class="col-md-offset-2 col-md-8">
                <span id="signinButton" >
                    <span
                        class="g-signin"
                        data-callback="authHandler"
                        data-clientid="@@google.client.id@@"
                        data-cookiepolicy="single_host_origin"
                        data-scope="profile">
                    </span>
                </span>
            </div>
        </script>

        <script id="logged-template" type="text/x-handlebars-template">
            <div class="row">
            <div class="col-md-12">
            <a href="#player/{{id}}"><img src="{{userIcon}}?sz=70"
                 class="img-thumbnail"
                 style="width:70px; height:70px; margin:-40px 0 0 0" /></a>
            <span class="h4">{{username}}</span>
            </div>
            </div>
            <div class="row" style="margin-top: 10px">
            <div class="col-md-12">
                <button type="button"
                    class="btn btn-default"
                    data-toggle="modal"
                    data-target="#award_window">
                        Award achievement
                </button>
            </div>
            </div>
        </script>


        <!-- Google+ auth -->
        <script type="text/javascript">
            (function() {
                var po = document.createElement('script');
                po.type = 'text/javascript';
                po.async = true;
                po.src = 'https://apis.google.com/js/client:plusone.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(po, s);
            })();
        </script>
    </body>
